using ChatVisual;
using System.Collections;
using System.Collections.Generic;
using UnityEngine;
using UnityEditor;
using UnityEngine.UIElements;
using System;

public class ChatEditor : EditorWindow
{
    [SerializeField]
    private VisualTreeAsset treeAsset = null;           // UI ??????壤굿??苑??낆뒩??곷뎨?

    private ChatView chatView;        // 癲?????????怨쀪퐨??좊읈? ????덉툗 ??
    private InspectorView inspectorView;        // ?嶺뚮ㅎ?ц짆???됰슣?????濡ろ뜏???
    private HierarchyView hierarchyView;      // ?熬곣뫀????쒑눧?뤒?ㅻ깹筌?GUI, ??ш끽維???癲ル슢??????? ???쒓낮???????
    private Button arrayAddBtn;
    private Button dangerBtn;

    private ChatContainer chatContainer;

    [MenuItem("ChatSystem/ChatEditor")]
    public static void OpenWindow()
    {
        GetWindow<ChatEditor>("ChatEditor");
    }

    private void OnDestroy()
    {
        //if (chatContainer != null)
        {
            //chatView.SaveChatSystem();      // 癲ル슓????????癲ル슣????ヂ????癒?? ??? ?????濚왿몾??솒?됰뻿???뀀탿
        }
    }

    public void CreateGUI()
    {
        VisualElement root = rootVisualElement;     // ??룸Ŧ爾??용굞肉????源놁젳???⑤ı??

        // UXML 癲ル슢???????⑥궢猷??
        VisualElement template = treeAsset.Instantiate();
        template.style.flexGrow = 1;        // ??釉먯뒠?????怨좊군 ?壤굿?????????⑥щ뼥????節뗪콬鶯????嶺?
        root.Add(template);

        var styleSheet = AssetDatabase.LoadAssetAtPath<StyleSheet>("Assets/ChatVisual/Editor/ChatEditor.uss");
        root.styleSheets.Add(styleSheet);       // ???????繹먮끏援???좊읈??嶺?濚?

        chatView = root.Q<ChatView>("chat-view");
        inspectorView = root.Q<InspectorView>("inspector-view");        // ?嶺뚮ㅎ?ц짆?????????????⑥????좊읈??嶺뚮ㅎ?닸쾮濡㏓섀?
        hierarchyView = root.Q<HierarchyView>("hierarchy-view");       // ??ш끽維?????좊읈??嶺뚮ㅎ?닸쾮濡㏓섀?hierarchy ??
       
        arrayAddBtn = root.Q<Button>("AddBtn");     // ?類??????좊읈??嶺뚮ㅎ?닸쾮濡㏓섀?
        arrayAddBtn.tooltip = "Chapter Add";
        arrayAddBtn.clickable.clicked += OnArrayAddBtn;
        dangerBtn = root.Q<Button>("ClearBtn");
        dangerBtn.tooltip = "All Nodes Delete";
        dangerBtn.clickable.clicked += OnClearNodes;

        chatView.OnNodeSelected += OnSelectionNodeChanged;      // ?嶺뚮ㅎ?볠뤃????ш끽諭???濡ろ뜏???????瑜??癲??????濚???嶺뚮ㅎ???

        OnSelectionChange();
    }

    private void OnArrayAddBtn()
    {
        if (chatContainer != null)
        {
            Debug.Log("?袁⑸즲?節덇덩???⑤베堉????⑥궢猷??");
            chatContainer.MainChapter.Add(new Chapter());
            hierarchyView.UpdateHierarchy(chatContainer, chatView);
        }
    }

    private void OnClearNodes()
    {
        if (chatContainer != null)
        {
            /*  foreach (var node in chatContainer.nodes)
              {
                  if (node is AskNode)
                  {
                      chatContainer.nodes.Remove(node);
                  }
              }*/
            Debug.Log("Number of nodes to create : " + chatContainer.nodes.Count);
        }
    }

    private void OnSelectionNodeChanged(NodeView nodeView)
    {
        //chatView.SaveChatSystem();
        inspectorView.UpdateInspector(nodeView);        // ???嶺뚮ㅎ?볠뤃????????됰텑???嶺뚮ㅎ?ц짆?????????????㉨?
    }

    private void OnSelectionChange()        // ??????? ?????ㅺ컼?????????뺤깓??곕굡筌??????ャ뀕????源낃도 ??
    {
        if (Selection.activeGameObject != null)
        {
            if (Selection.activeGameObject.TryGetComponent<ChatContainer>(out chatContainer))      // ???쒓낮???????癲ル슓???듦덩????좊읈??嶺뚮ㅎ?닸쾮濡㏓섀?
            {
                //Debug.Log(chatContainer.nodes.Count + "??좊즵獒???嶺뚮ㅎ?볠뤃?믩쨬??쎛 ?釉뚰????");

                chatContainer.ChangeNowChapter(0);      // ??좊읈???癲ル슪?ｇ몭??? 0?類????

                hierarchyView.UpdateHierarchy(chatContainer, chatView);      // ???쒓낮???????癲ル슢???????⑥궢猷??
                
                chatView.LoadChatSystem(chatContainer);     // ???Β?????棺??짆?삠궘????⑥궢猷??
                chatView.PopulateView();           // ???Β????? ??れ삀??뫢???⑥???怨뚮옖??????癲ル슢???????⑥궢猷??

                Debug.Log($"MainChapter count : {chatContainer.MainChapter.Count}");
            }
        }
    }
}
