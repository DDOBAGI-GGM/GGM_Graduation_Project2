using ChatVisual;
using System.Collections;
using System.Collections.Generic;
using UnityEngine;
using UnityEditor;
using UnityEngine.UIElements;
using System;

public class ChatEditor : EditorWindow
{
    [SerializeField]
    private VisualTreeAsset treeAsset = null;           // UI ???????????????????⑹름????ㅿ폍??

    private ChatView chatView;        // ????????????????얠?????ル늉?? ???????????
    private InspectorView inspectorView;        // ??轅붽틓????嶺?????⑥ル츧??????棺堉?뤃????
    private HierarchyView hierarchyView;      // ?????밸븶???????얜Ŧ??嶺뚮슢?????怨뺤떪??GUI, ?????諛몃마????饔낅떽????????? ????癰궽블뀮???????
    private Button arrayAddBtn;
    private Button dangerBtn;

    private ChatContainer chatContainer;

    [MenuItem("ChatSystem/ChatEditor")]
    public static void OpenWindow()
    {
        GetWindow<ChatEditor>("ChatEditor");
    }

    private void OnDestroy()
    {
        //if (chatContainer != null)
        {
            //chatView.SaveChatSystem();      // ?饔낅떽???????????饔낅떽???????亦낃콛???????? ??? ??????關??濡녹춻??????⑤베????????
        }
    }

    public void CreateGUI()
    {
        VisualElement root = rootVisualElement;     // ???猷멤꼻??????猷산샵?????嚥싲갭큔?????????

        // UXML ?饔낅떽??????????鰲????
        VisualElement template = treeAsset.Instantiate();
        template.style.flexGrow = 1;        // ????嫄????????關履??????????????????????????鶯ㅺ동?????룴???????
        root.Add(template);

        var styleSheet = AssetDatabase.LoadAssetAtPath<StyleSheet>("Assets/ChatVisual/Editor/ChatEditor.uss");
        root.styleSheets.Add(styleSheet);       // ????????μ떜媛?걫?筌뚮챶夷?????ル늉???????

        chatView = root.Q<ChatView>("chat-view");
        inspectorView = root.Q<InspectorView>("inspector-view");        // ??轅붽틓????嶺??????????????????????ル늉????轅붽틓????筌뤾쑴裕?棺堉?뙴???
        hierarchyView = root.Q<HierarchyView>("hierarchy-view");       // ?????諛몃마???????ル늉????轅붽틓????筌뤾쑴裕?棺堉?뙴???hierarchy ??
       
        arrayAddBtn = root.Q<Button>("AddBtn");     // ?癲?????????ル늉????轅붽틓????筌뤾쑴裕?棺堉?뙴???
        arrayAddBtn.tooltip = "Chapter Add";
        arrayAddBtn.clickable.clicked += OnArrayAddBtn;
        dangerBtn = root.Q<Button>("ClearBtn");
        dangerBtn.tooltip = "All Nodes Delete";
        dangerBtn.clickable.clicked += OnClearNodes;

        chatView.OnNodeSelected += OnSelectionNodeChanged;      // ??轅붽틓????곌램伊볟ㅇ????????덇텣????棺堉?뤃???????????????????????轅붽틓?????

        OnSelectionChange();
    }

    private void OnArrayAddBtn()
    {
        if (chatContainer != null)
        {
            Debug.Log("Add human");
            hierarchyView.UpdateHierarchy(chatContainer, chatView);
        }
    }

    private void OnClearNodes()
    {
        if (chatContainer != null)
        {
            Debug.Log("Delete all nodes");
        }
    }

    private void OnSelectionNodeChanged(NodeView nodeView)
    {
        //chatView.SaveChatSystem();
        inspectorView.UpdateInspector(nodeView);        // ????轅붽틓????곌램伊볟ㅇ??????????⑥쥓?????轅붽틓????嶺???????????????
    }

    private void OnSelectionChange()        // ??????? ???????됰Ŧ鍮?????????嶺뚮Ĳ??????ㅻ쿅??녳뵾???????影?력????嚥싲갭큔?????
    {
        if (Selection.activeGameObject != null)
        {
            if (Selection.activeGameObject.TryGetComponent<ChatContainer>(out chatContainer))      // ????癰궽블뀮????????饔낅떽??????????????ル늉????轅붽틓????筌뤾쑴裕?棺堉?뙴???
            {
                // The current chat is an assistant's chat
                chatContainer.nowHumanName = "Assistant";
                chatContainer.nowChatNodeList = chatContainer.HumanAndChatDictionary["Assistant"];

                //hierarchyView.UpdateHierarchy(chatContainer, chatView);      // ????癰궽블뀮????????饔낅떽??????????鰲????

                chatView.LoadChatData(chatContainer);     // ??????????癲??嶺???ル맪??????鰲????
                chatView.PopulateView();           // ?????????? ???????力?肉?????????????쇰뮛????????饔낅떽??????????鰲????

                //Debug.Log($"Human count : {chatContainer.HumanAndChatDictionary.Count}");
            }
        }
    }
}
